# Message Contracts with Protobuf
Protobuf allows us to define message contracts/format in a centralized location using a shared DSL, then export those contracts into the language of your choice!

In this manner, we can maintain shared message contracts across applications and squads during our development flows.

Code in this repo supports conversion to Ruby classes. We can add Elixir support with [this package.](https://github.com/tony612/protobuf-elixir)

## Getting Started

* Define your `.proto` message contracts in `lib/src/`
* Convert your `.proto` file into Ruby!

```
docker-compose run converter <language> <commands/events> <name of message>
```

ex -
Where there is a file that defines a command `lib/src/commands/create_batch.proto`, and I want a Ruby class:

```
docker-compose run converter ruby commands create_batch
```
* Find your file in `lib/build/ruby/`

## Example

The `lib/build/ruby/create_batch_pb.rb` file was generated by protoc with the above script. This file will then be taken and added to Ironboard source code. Then, you can use the message class like this:

(NOTE: Checkout `ipc-batch-exchange`) branch on Ironboard and run `rails c` and paste in the contents the generated `lib/build/ruby/create_batch_prb.rb` or add that file to Ironboard source to play around with it. This branch has the `google-protobuf` gem installed).


```ruby
data = Ipc::CreateBatch::Data.new(iteration: "test-batch")
message = Ipc::CreateBatch.new(user_id: 1, correlation_id: 1234, uuid: "1243", type: "CreateBatch", data: data)

# publisher will convert message to JSON
Ipc::Publishers::BatchPublisher.publish(message)
```

## Questions
* Do we want to leverage GitHub Actions to keep message classes in sync? How can we programmatically determine where and how to open PRs when message contracts change? Some kind of config for repos against which to open PRs and naming conventions/file structure conventions. Like, some kind of config that says: `repo: Ironboard, lang: ruby` and then PR will automatically get opened against in Ironboard against `lib/messages/<commands/events>`? 
