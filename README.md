# Message Contracts with Protobuf
Protobuf allows us to define message contracts/format in a centralized location using a shared DSL, then export those contracts into the language of your choice!

In this manner, we can maintain shared message contracts across applications and squads during our development flows.

Code in this repo supports conversion to Ruby classes. We can add Elixir support with [this package.](https://github.com/tony612/protobuf-elixir)

## Getting Started

* Define your `.proto` message contracts in `lib/src/`
* Convert your `.proto` file into Ruby!

```
docker-compose run converter <language> <name of message>
```

ex -
Where there is a file `lib/src/create_batch.proto`, and I want a Ruby class:

```
docker-compose run converter ruby create_batch
```
* Find your file in `lib/build/ruby/`

## Example

The `lib/build/ruby/create_batch_pb.rb` file was generated by protoc with the above script. This file will then be taken and added to Ironboard source code. Then, you can use the message class like this:

(NOTE: Checkout `ipc-batch-exchange`) branch on Ironboard and run `rails c` and paste in the contents the generated `lib/build/ruby/create_batch_prb.rb` or add that file to Ironboard source to play around with it. This branch has the `google-protobuf` gem installed).


```ruby
data = Ipc::CreateBatch::Data.new(iteration: "test-batch")
message = Ipc::CreateBatch.new(user_id: 1, correlation_id: 1234, uuid: "1243", type: "CreateBatch", data: data)

# publisher will convert message to JSON
Ipc::Publishers::BatchPublisher.publish(message)
```

## Questions
* How to get default values for fields? For example, I want `type` field to default to `"CreateBatch"`. Shouldn't be the responsibility of the person using this class and instantiating a message to know that `type` should match class name.
* Even though I've marked the fields as `required`, nothing seems to be enforcing these requirements. Do we want to require fields and how should it behave when required fields are missing?
  * Can't figure it out. Doesn't blow up when I initialize w/o required fields, when I decode/encoded without required fields...
* You MUST decode your encoded message with the same message class the encoded it. Options:
  * Encode messages to JSON, not bytes
  * Leverage `meta` key of Rabbitmq to include message type
  * Leverage the Rabbitmq `routing_key`
* Best practices for leveraging this tool?
  * Define messages in central repo (here)
  * Use provided script to convert to your preferred language
  * Then...what? Copy paste file into your app's source code?
